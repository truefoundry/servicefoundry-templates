version: 1
name: ${service_name}

build:
    service_build:
        service_type: fast_api_build
        version: python:3.7
        service: main.py
        packages: requirements.txt

        build_dir: /tmp
        port: 80
        ignore_patterns: [.garbage.txt]

deploy:
    https_service:
        namespace: ${stage.space}
        port: 80
        cpu: 0.5
        cpu_limit: 0.5
        memory: 512000000
        memory_limit: 1024000000
        instances: ${stage.INSTANCES}
        env:
            MY_SECRET: ${stage.MY_SECRET}
            NUM_THREADS: 10
        health_check:
            endpoint: ./health
            period_seconds: 10
            initial_delay: 50
        metrics_endpoint: ./metrics

envs:
    dev:
        space: us-east-1-c1:cloud:int-space
        INSTANCES: 1
        MY_SECRET: ${tfy:cloud:my-secret-group:my-secret}
    staging:
        space: truefoundry-eks-develop:cliunittest1-prod
        INSTANCES: 10
        MY_SECRET: ${tfy:cloud:my-secret-group:my-secret}